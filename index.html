<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greenhouse Dashboard — Text Only (Per-Zone Tables)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0f0c; --card:#0f1511; --muted:#9fb3a6; --accent:#2e8b57; --border:#1e3b2a; --text:#f3f7f4; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .topbar { display:flex; align-items:center; padding:10px 14px; background:#0c150f; border-bottom:1px solid var(--border); }
    .brand { font-weight:700; letter-spacing:.4px; }
    main { padding:16px; max-width:1100px; margin:0 auto; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; margin-bottom:16px; }
    .zones { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:16px; }
    @media (max-width: 900px) { .zones { grid-template-columns: 1fr; } }
    .zone h3 { margin:6px 0 10px; }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap:6px 12px; align-items:center; }
    .k { color: var(--muted); }
    .v { font-variant-numeric: tabular-nums; }
    .updated { color: var(--muted); font-size: 13px; margin-top: 8px; }
    .status { color:#ffb4a6; font-size:14px; margin-bottom:10px; min-height: 1.2em; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:#cfe9dc; background:#143a27; font-size:12px; margin-left:8px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">Greenhouse Dashboard — Text Only</div>
  </header>

  <main>
    <section class="card">
      <div id="status" class="status"></div>
      <div class="zones" id="zonesContainer"></div>
    </section>
  </main>

  <script>
    // Supabase config (public anon key is safe to embed)
    const SUPABASE_URL = "https://qzkvrcscrjkppcnuvbdt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6a3ZyY3NjcmprcHBjbnV2YmR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjUwODUsImV4cCI6MjA3MzM0MTA4NX0.z6NDGzZqhSjuxDQj4kkw9ZF-wLKRQNKoEXxz9htlZgY";

    // Four separate tables, one per zone
    const ZONES = [1,2,3,4];
    const ZONE_TABLES = { 1:"zone1", 2:"zone2", 3:"zone3", 4:"zone4" };

    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl = document.getElementById("status");
    const zonesContainer = document.getElementById("zonesContainer");

    function zoneCardHTML(zone) {
      const t = ZONE_TABLES[zone];
      return `
        <section class="card zone" id="zone-${zone}">
          <h3>Zone ${zone} <span class="badge">${t}</span></h3>
          <div class="kv">
            <div class="k">Air Temp</div><div class="v" id="z${zone}-air">-- °C</div>
            <div class="k">Relative Humidity</div><div class="v" id="z${zone}-rh">-- %</div>
            <div class="k">Soil Voltage</div><div class="v" id="z${zone}-soil">-- V</div>
            <div class="k">Root Temp</div><div class="v" id="z${zone}-root">-- °C</div>
          </div>
          <div class="updated" id="z${zone}-updated">Last update: --</div>
        </section>
      `;
    }
    zonesContainer.innerHTML = ZONES.map(z => zoneCardHTML(z)).join("");

    const lastEpoch = { 1:null, 2:null, 3:null, 4:null };

    function fmt(v, d, suf) {
      if (v === null || v === undefined || !Number.isFinite(v)) return `-- ${suf}`;
      return `${v.toFixed(d)} ${suf}`;
    }
    function setText(id, txt) {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    }
    function toNum(x) {
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }
    function agoString(epochSec) {
      if (!epochSec) return "--";
      const diff = Math.max(0, Math.floor(Date.now()/1000 - epochSec));
      if (diff < 5) return "just now";
      if (diff < 60) return `${diff}s ago`;
      const m = Math.floor(diff/60);
      if (m < 60) return `${m}m ago`;
      const h = Math.floor(m/60);
      return `${h}h ago`;
    }
    function refreshUpdated(zone) {
      const el = document.getElementById(`z${zone}-updated`);
      if (el) el.textContent = `Last update: ${agoString(lastEpoch[zone])}`;
    }
    setInterval(() => { ZONES.forEach(refreshUpdated); }, 10_000);

    function updateZoneUI(zone, row) {
      if (!row) return;
      const air  = toNum(row.air_c);
      const rh   = toNum(row.rh_pct);
      const soil = toNum(row.soil_v);
      const root = toNum(row.root_c);
      setText(`z${zone}-air`,  fmt(air, 1, "°C"));
      setText(`z${zone}-rh`,   fmt(rh, 0, "%"));
      setText(`z${zone}-soil`, fmt(soil, 3, "V"));
      setText(`z${zone}-root`, fmt(root, 1, "°C"));
      const ep = toNum(row.epoch);
      if (ep) lastEpoch[zone] = ep;
      refreshUpdated(zone);
    }

    async function loadLatest(zone) {
      const table = ZONE_TABLES[zone];
      try {
        const { data, error } = await supabase
          .from(table)
          .select("epoch, air_c, rh_pct, soil_v, root_c")
          .order("epoch", { ascending: false })
          .limit(1);
        if (error) throw error;
        if (data && data.length) updateZoneUI(zone, data[0]);
      } catch (e) {
        console.warn(`Load error ${table}:`, e);
        statusEl.textContent = `Load error ${table}: ${e.message || e}`;
      }
    }

    function subscribeZone(zone) {
      const table = ZONE_TABLES[zone];
      const ch = supabase
        .channel(`rt:${table}`)
        .on("postgres_changes",
          { event: "INSERT", schema: "public", table },
          (payload) => {
            const row = payload.new || {};
            updateZoneUI(zone, row);
          }
        )
        .subscribe((status) => {
          if (status === "SUBSCRIBED") console.log(`Realtime subscribed: ${table}`);
        });
      return ch;
    }

    async function init() {
      await Promise.all(ZONES.map(loadLatest));
      ZONES.forEach(subscribeZone);
      // Poll fallback in case realtime is blocked by network
      setInterval(() => { ZONES.forEach(loadLatest); }, 60_000);
    }

    init();
  </script>
</body>
</html>
