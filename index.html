<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greenhouse Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Styles (inline for single-file deploy) -->
  <style>
    :root {
      --bg: #0b0f0c;
      --card: #0f1511;
      --muted: #9fb3a6;
      --accent: #2e8b57;
      --border: #1e3b2a;
      --text: #f3f7f4;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    .topbar {
      display: flex; align-items: center; padding: 10px 14px;
      background: #0c150f; border-bottom: 1px solid var(--border);
    }
    .brand { font-weight: 700; letter-spacing: 0.4px; }
    .spacer { flex: 1; }
    .userbox { display: flex; gap: 10px; align-items: center; }
    .hidden { display: none; }

    .btn {
      background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 8px;
      cursor: pointer;
    }

    main { padding: 16px; max-width: 1320px; margin: 0 auto; }
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px;
      padding: 14px; margin-bottom: 16px;
    }

    .auth { max-width: 420px; margin: 40px auto; }
    .auth input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: #0e1511; color: var(--text); }
    .auth .muted { color: var(--muted); margin-top: 8px; }

    .dashboard h2 { margin: 6px 0 12px; }
    .zones {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    .zone h3 { margin: 6px 0 10px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .chart-card { min-height: 240px; }
    .chart-card h4 { margin: 4px 0 8px; color: var(--muted); font-weight: 600; }

    .footer { text-align: center; color: var(--muted); padding: 20px 0 60px; }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">Greenhouse Dashboard</div>
    <div class="spacer"></div>
    <div id="userBox" class="userbox hidden">
      <span id="userEmail">--</span>
      <button id="signOutBtn" class="btn">Sign out</button>
    </div>
  </header>

  <main id="app">
    <section id="authSection" class="card auth">
      <h2>Sign in</h2>
      <p>Enter your email to receive a magic link.</p>
      <form id="loginForm">
        <input id="emailInput" type="email" placeholder="you@example.com" required />
        <button type="submit" class="btn">Send magic link</button>
      </form>
      <p id="authMsg" class="muted"></p>
    </section>

    <section id="dashSection" class="dashboard hidden">
      <h2>Zones: zone1 — zone4</h2>
      <div id="zonesContainer" class="zones"></div>
    </section>
  </main>

  <footer class="footer">
    <span>Powered by Supabase</span>
  </footer>

  <script>
    // --------------- Configure your project ---------------
    // Using SUPABASE_URL from your .env: https://qzkvrcscrjkppcnuvbdt.supabase.co
    const SUPABASE_URL = "https://qzkvrcscrjkppcnuvbdt.supabase.co";
    // IMPORTANT: Replace with your anon public key (Project Settings > API). Do NOT use the service key here.
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6a3ZyY3NjcmprcHBjbnV2YmR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NTA4NSwiZXhwIjoyMDczMzQxMDg1fQ.DthLi51vD04-odNZqYO9n44ObB9actAaevlRWQmD9Ro";

    // Per-zone tables in your DB
    const ZONES = [1, 2, 3, 4];
    const ZONE_TABLES = { 1: "zone1", 2: "zone2", 3: "zone3", 4: "zone4" };

    // Minutes of history to load initially
    const HISTORY_MINUTES = 60;
    // ------------------------------------------------------

    const COLORS = { air: "#00FFFF", rh: "#FFD700", soil: "#FF7F50", root: "#7CFC00" };
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (sel) => document.querySelector(sel);
    const authSection = el("#authSection");
    const dashSection = el("#dashSection");
    const userBox = el("#userBox");
    const userEmailSpan = el("#userEmail");
    const signOutBtn = el("#signOutBtn");
    const zonesContainer = el("#zonesContainer");
    const loginForm = el("#loginForm");
    const emailInput = el("#emailInput");
    const authMsg = el("#authMsg");

    function createZoneCard(zone) {
      const wrap = document.createElement("section");
      wrap.className = "card zone";
      wrap.innerHTML = `
        <h3>Zone ${zone} (${ZONE_TABLES[zone]})</h3>
        <div class="grid">
          <div class="chart-card">
            <h4>Air Temp (°C)</h4>
            <canvas id="z${zone}-air"></canvas>
          </div>
          <div class="chart-card">
            <h4>Relative Humidity (%)</h4>
            <canvas id="z${zone}-rh"></canvas>
          </div>
          <div class="chart-card">
            <h4>Soil Voltage (V)</h4>
            <canvas id="z${zone}-soil"></canvas>
          </div>
          <div class="chart-card">
            <h4>Root Temp (°C)</h4>
            <canvas id="z${zone}-root"></canvas>
          </div>
        </div>
      `;
      zonesContainer.appendChild(wrap);
    }

    const charts = {};
    function makeLineChart(canvas, color, label) {
      const ctx = canvas.getContext("2d");
      return new Chart(ctx, {
        type: "line",
        data: { datasets: [{ label, data: [], borderColor: color, pointRadius: 0, borderWidth: 1.6, tension: 0.2 }] },
        options: {
          animation: false, responsive: true, maintainAspectRatio: false,
          scales: {
            x: {
              type: "linear",
              ticks: {
                color: "#eee",
                callback: (v) => {
                  const now = Date.now()/1000;
                  const mins = Math.max(0, Math.round((now - v)/60));
                  return `${mins}m`;
                }
              },
              grid: { color: "rgba(255,255,255,0.1)" }
            },
            y: { ticks: { color: "#eee" }, grid: { color: "rgba(255,255,255,0.1)" } }
          },
          plugins: {
            legend: { labels: { color: "#eee" } },
            tooltip: { callbacks: { title: (items) => new Date(items[0].parsed.x*1000).toLocaleString() } }
          }
        }
      });
    }

    async function loadInitial(zone) {
      const table = ZONE_TABLES[zone];
      const since = (Date.now()/1000) - (HISTORY_MINUTES * 60);
      const { data, error } = await supabase
        .from(table)
        .select("epoch, air_c, rh_pct, soil_v, root_c")
        .gt("epoch", since)
        .order("epoch", { ascending: true });
      if (error) {
        console.warn("initial load error", table, error);
        return;
      }
      for (const r of (data || [])) {
        const x = r.epoch;
        if (r.air_c  != null) charts[zone].air.data.datasets[0].data.push({ x, y: r.air_c });
        if (r.rh_pct != null) charts[zone].rh.data.datasets[0].data.push({ x, y: r.rh_pct });
        if (r.soil_v != null) charts[zone].soil.data.datasets[0].data.push({ x, y: r.soil_v });
        if (r.root_c != null) charts[zone].root.data.datasets[0].data.push({ x, y: r.root_c });
      }
      Object.values(charts[zone]).forEach(c => c.update());
    }

    function keepWithinHours(zone, hours=6) {
      const cutoff = (Date.now()/1000) - (hours*3600);
      for (const key of ["air","rh","soil","root"]) {
        const ds = charts[zone][key].data.datasets[0].data;
        charts[zone][key].data.datasets[0].data = ds.filter(p => p.x > cutoff);
      }
    }

    function subscribeRealtime(zone) {
      const table = ZONE_TABLES[zone];
      const channel = supabase
        .channel(`realtime:${table}`)
        .on("postgres_changes", { event: "INSERT", schema: "public", table }, (payload) => {
          const r = payload.new;
          const x = r.epoch;
          if (r.air_c  != null) charts[zone].air.data.datasets[0].data.push({ x, y: r.air_c });
          if (r.rh_pct != null) charts[zone].rh.data.datasets[0].data.push({ x, y: r.rh_pct });
          if (r.soil_v != null) charts[zone].soil.data.datasets[0].data.push({ x, y: r.soil_v });
          if (r.root_c != null) charts[zone].root.data.datasets[0].data.push({ x, y: r.root_c });
          keepWithinHours(zone, 6);
          Object.values(charts[zone]).forEach(c => c.update());
        })
        .subscribe((status) => {
          if (status === "SUBSCRIBED") console.log(`Realtime subscribed: ${table}`);
        });
      return channel;
    }

    function showAuth() {
      authSection.classList.remove("hidden");
      dashSection.classList.add("hidden");
      userBox.classList.add("hidden");
    }

    function showDash(user) {
      userEmailSpan.textContent = user?.email ?? "";
      userBox.classList.remove("hidden");
      authSection.classList.add("hidden");
      dashSection.classList.remove("hidden");
    }

    let activeChannels = [];
    async function initCharts() {
      // Cleanup prior subscriptions if any
      activeChannels.forEach(ch => supabase.removeChannel(ch));
      activeChannels = [];

      zonesContainer.innerHTML = "";
      for (const z of ZONES) {
        createZoneCard(z);
        charts[z] = {
          air:  makeLineChart(document.getElementById(`z${z}-air`),  COLORS.air,  "Air °C"),
          rh:   makeLineChart(document.getElementById(`z${z}-rh`),   COLORS.rh,   "RH %"),
          soil: makeLineChart(document.getElementById(`z${z}-soil`), COLORS.soil, "Soil V"),
          root: makeLineChart(document.getElementById(`z${z}-root`), COLORS.root, "Root °C"),
        };
      }
      await Promise.all(ZONES.map(z => loadInitial(z)));
      activeChannels = ZONES.map(z => subscribeRealtime(z));
    }

    async function refreshSessionAndRoute() {
      const { data, error } = await supabase.auth.getSession();
      if (error) console.warn("getSession error:", error);
      if (data.session && data.session.user) {
        showDash(data.session.user);
        initCharts();
      } else {
        showAuth();
      }
    }

    // Auth: Magic link with explicit redirect (must be allow-listed in Supabase Auth settings)
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();
      if (!email) return;

      const redirectTo = window.location.origin + window.location.pathname;

      authMsg.textContent = "Sending magic link…";
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: redirectTo,
          shouldCreateUser: true
        }
      });

      if (error) {
        console.error("signInWithOtp error:", error);
        authMsg.textContent = `Error: ${error.message}`;
      } else {
        authMsg.textContent = "Check your email for the magic link.";
      }
    });

    signOutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      // Clean up realtime subscriptions
      activeChannels.forEach(ch => supabase.removeChannel(ch));
      activeChannels = [];
      location.reload();
    });

    supabase.auth.onAuthStateChange((_event, session) => {
      if (session?.user) { showDash(session.user); initCharts(); }
      else { showAuth(); }
    });

    // Kick off
    refreshSessionAndRoute();
  </script>
</body>
</html>
