<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greenhouse Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root { --bg:#0b0f0c; --card:#0f1511; --muted:#9fb3a6; --accent:#2e8b57; --border:#1e3b2a; --text:#f3f7f4; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .topbar { display:flex; align-items:center; padding:10px 14px; background:#0c150f; border-bottom:1px solid var(--border); }
    .brand { font-weight:700; letter-spacing:.4px; }
    main { padding:16px; max-width:1320px; margin:0 auto; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; margin-bottom:16px; }
    .zones { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:16px; }
    .zone h3 { margin:6px 0 10px; }
    .grid { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px; }
    .chart-card { min-height:240px; }
    .chart-card h4 { margin:4px 0 8px; color:var(--muted); font-weight:600; }
    .footer { text-align:center; color:var(--muted); padding:20px 0 60px; }
    .note { color: var(--muted); font-size: 14px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">Greenhouse Dashboard (Public Read)</div>
  </header>

  <main>
    <section class="card">
      <h2>Zones: zone1 — zone4</h2>
      <p class="note">This page is public-read. Ensure you are using the Supabase anon public key, not the service key.</p>
      <div id="zonesContainer" class="zones"></div>
    </section>
  </main>

  <footer class="footer">
    <span>Powered by Supabase</span>
  </footer>

  <script>
    // Supabase config (from your .env and Supabase Settings)
    const SUPABASE_URL = "https://qzkvrcscrjkppcnuvbdt.supabase.co"; // from .env
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6a3ZyY3NjcmprcHBjbnV2YmR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NTA4NSwiZXhwIjoyMDczMzQxMDg1fQ.DthLi51vD04-odNZqYO9n44ObB9actAaevlRWQmD9Ro";     // Settings > API > Public anon key

    // Per-zone tables (columns: epoch, date, time, air_c, rh_pct, soil_v, root_c)
    const ZONES = [1,2,3,4];
    const ZONE_TABLES = { 1: "zone1", 2: "zone2", 3: "zone3", 4: "zone4" };
    const HISTORY_MINUTES = 60;

    const COLORS = { air:"#00FFFF", rh:"#FFD700", soil:"#FF7F50", root:"#7CFC00" };
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const zonesContainer = document.getElementById("zonesContainer");
    const charts = {};

    function createZoneCard(zone) {
      const wrap = document.createElement("section");
      wrap.className = "card zone";
      wrap.innerHTML = `
        <h3>Zone ${zone} (${ZONE_TABLES[zone]})</h3>
        <div class="grid">
          <div class="chart-card"><h4>Air Temp (°C)</h4><canvas id="z${zone}-air"></canvas></div>
          <div class="chart-card"><h4>Relative Humidity (%)</h4><canvas id="z${zone}-rh"></canvas></div>
          <div class="chart-card"><h4>Soil Voltage (V)</h4><canvas id="z${zone}-soil"></canvas></div>
          <div class="chart-card"><h4>Root Temp (°C)</h4><canvas id="z${zone}-root"></canvas></div>
        </div>`;
      zonesContainer.appendChild(wrap);
    }

    function makeLineChart(canvas, color, label) {
      const ctx = canvas.getContext("2d");
      return new Chart(ctx, {
        type: "line",
        data: { datasets: [{ label, data: [], borderColor: color, pointRadius: 0, borderWidth: 1.6, tension: 0.2 }] },
        options: {
          animation: false, responsive: true, maintainAspectRatio: false,
          scales: {
            x: {
              type: "linear",
              ticks: {
                color: "#eee",
                callback: (v) => {
                  const now = Date.now()/1000;
                  const mins = Math.max(0, Math.round((now - v)/60));
                  return `${mins}m`;
                }
              },
              grid: { color: "rgba(255,255,255,0.1)" }
            },
            y: { ticks: { color: "#eee" }, grid: { color: "rgba(255,255,255,0.1)" } }
          },
          plugins: {
            legend: { labels: { color: "#eee" } },
            tooltip: { callbacks: { title: (items) => new Date(items[0].parsed.x*1000).toLocaleString() } }
          }
        }
      });
    }

    async function loadInitial(zone) {
      const table = ZONE_TABLES[zone];
      const since = (Date.now()/1000) - (HISTORY_MINUTES * 60);
      const { data, error } = await supabase
        .from(table)
        .select("epoch, air_c, rh_pct, soil_v, root_c")
        .gt("epoch", since)
        .order("epoch", { ascending: true });

      if (error) {
        console.warn(`Initial load error for ${table}:`, error);
        return;
      }
      for (const r of (data || [])) {
        const x = r.epoch;
        if (r.air_c  != null) charts[zone].air.data.datasets[0].data.push({ x, y: r.air_c });
        if (r.rh_pct != null) charts[zone].rh.data.datasets[0].data.push({ x, y: r.rh_pct });
        if (r.soil_v != null) charts[zone].soil.data.datasets[0].data.push({ x, y: r.soil_v });
        if (r.root_c != null) charts[zone].root.data.datasets[0].data.push({ x, y: r.root_c });
      }
      Object.values(charts[zone]).forEach(c => c.update());
    }

    function keepWithinHours(zone, hours=6) {
      const cutoff = (Date.now()/1000) - (hours*3600);
      for (const key of ["air","rh","soil","root"]) {
        const ds = charts[zone][key].data.datasets[0].data;
        charts[zone][key].data.datasets[0].data = ds.filter(p => p.x > cutoff);
      }
    }

    function subscribeRealtime(zone) {
      const table = ZONE_TABLES[zone];
      const ch = supabase
        .channel(`realtime:${table}`)
        .on("postgres_changes", { event: "INSERT", schema: "public", table }, (payload) => {
          const r = payload.new;
          const x = r.epoch;
          if (r.air_c  != null) charts[zone].air.data.datasets[0].data.push({ x, y: r.air_c });
          if (r.rh_pct != null) charts[zone].rh.data.datasets[0].data.push({ x, y: r.rh_pct });
          if (r.soil_v != null) charts[zone].soil.data.datasets[0].data.push({ x, y: r.soil_v });
          if (r.root_c != null) charts[zone].root.data.datasets[0].data.push({ x, y: r.root_c });
          keepWithinHours(zone, 6);
          Object.values(charts[zone]).forEach(c => c.update());
        })
        .subscribe(status => {
          if (status === "SUBSCRIBED") console.log(`Realtime subscribed: ${table}`);
        });
      return ch;
    }

    async function init() {
      zonesContainer.innerHTML = "";
      for (const z of ZONES) {
        createZoneCard(z);
        charts[z] = {
          air:  makeLineChart(document.getElementById(`z${z}-air`),  COLORS.air,  "Air °C"),
          rh:   makeLineChart(document.getElementById(`z${z}-rh`),   COLORS.rh,   "RH %"),
          soil: makeLineChart(document.getElementById(`z${z}-soil`), COLORS.soil, "Soil V"),
          root: makeLineChart(document.getElementById(`z${z}-root`), COLORS.root, "Root °C"),
        };
      }
      await Promise.all(ZONES.map(z => loadInitial(z)));
      ZONES.forEach(z => subscribeRealtime(z));
    }

    init();
  </script>
</body>
</html>
